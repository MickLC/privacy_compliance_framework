# modules/jurisdiction_registry.yml - Jurisdiction Registry Module
---
# Jurisdiction registry - manages the repository of privacy laws
---
objects from file:
  - gdpr_requirements: gdpr_requirements.json
  - ccpa_requirements: ccpa_requirements.json
  - tdpsa_requirements: tdpsa_requirements.json
---
question: "Step 2: Jurisdictional Analysis"
subquestion: |
  Based on your business profile, we'll now determine which privacy laws apply to your operations.
  
  The system will analyze:
  - Where your business operates
  - Where your customers/clients are located
  - Your industry-specific regulations
  - Data volumes and types you process

continue button field: show_jurisdiction_intro
---
code: |
  def load_jurisdiction_registry():
    """Load the registry of all supported jurisdictions"""
    global jurisdiction_registry
    
    if not defined('jurisdiction_registry'):
      jurisdiction_registry = {
        "jurisdictions": [
          {
            "id": "gdpr",
            "name": "General Data Protection Regulation",
            "short_name": "GDPR",
            "region": "European Union",
            "type": "comprehensive",
            "effective_date": "2018-05-25",
            "latest_amendment": "2023-01-01",
            "requirements_file": "gdpr_requirements.json",
            "applicability_function": "is_gdpr_applicable"
          },
          {
            "id": "ccpa",
            "name": "California Consumer Privacy Act / California Privacy Rights Act",
            "short_name": "CCPA/CPRA",
            "region": "California, USA",
            "type": "comprehensive",
            "effective_date": "2020-01-01",
            "latest_amendment": "2023-01-01",
            "requirements_file": "ccpa_requirements.json",
            "applicability_function": "is_ccpa_applicable"
          },
          {
            "id": "tdpsa",
            "name": "Texas Data Privacy and Security Act",
            "short_name": "TDPSA",
            "region": "Texas, USA",
            "type": "comprehensive",
            "effective_date": "2024-07-01",
            "latest_amendment": None,
            "requirements_file": "tdpsa_requirements.json",
            "applicability_function": "is_tdpsa_applicable"
          },
          {
            "id": "hipaa",
            "name": "Health Insurance Portability and Accountability Act",
            "short_name": "HIPAA",
            "region": "United States",
            "type": "sectoral",
            "effective_date": "2003-04-14",
            "latest_amendment": "2013-03-26",
            "requirements_file": "hipaa_requirements.json",
            "applicability_function": "is_hipaa_applicable"
          },
          {
            "id": "glba",
            "name": "Gramm-Leach-Bliley Act",
            "short_name": "GLBA",
            "region": "United States",
            "type": "sectoral",
            "effective_date": "1999-11-12",
            "latest_amendment": "2022-10-27",
            "requirements_file": "glba_requirements.json",
            "applicability_function": "is_glba_applicable"
          }
        ]
      }
    
    return jurisdiction_registry
---
code: |
  def determine_applicable_jurisdictions():
    """Determine which privacy jurisdictions apply to the business"""
    global applicable_jurisdictions
    applicable_jurisdictions = []
    
    # For each jurisdiction in the registry, check applicability
    for jurisdiction in jurisdiction_registry["jurisdictions"]:
      # Get the appropriate applicability function
      func_name = jurisdiction["applicability_function"]
      
      # Call the applicability function
      if globals()[func_name]():
        applicable_jurisdictions.append(jurisdiction["id"])
    
    return applicable_jurisdictions
  
  def is_gdpr_applicable():
    """Determine if GDPR applies"""
    return serves_eu or has_eu_establishment
  
  def is_ccpa_applicable():
    """Determine if CCPA/CPRA applies"""
    return ((company.annual_revenue >= 25000000 or 
             california_records >= 100000 or
             (california_records >= 50000 and sells_personal_info)) and
            ('California' in states_with_locations or california_records > 0))
  
  def is_tdpsa_applicable():
    """Determine if Texas TDPSA applies - Enhanced with SBA size standards"""
    # First check if business has Texas presence
    has_texas_presence = ('Texas' in states_with_locations or texas_records > 0)
    
    if not has_texas_presence:
      return False
    
    # Check data volume thresholds
    meets_data_thresholds = (texas_records >= 100000 or 
                            (texas_records >= 25000 and sells_personal_info))
    
    if not meets_data_thresholds:
      return False
    
    # Check if business qualifies as small business (exempt from TDPSA)
    if (defined('company.naics_code') and defined('company.employee_count') and 
        defined('company.annual_revenue')):
      
      is_small_business = is_small_business_under_tdpsa(
        company.naics_code, 
        company.employee_count, 
        company.annual_revenue
      )
      
      # TDPSA applies if NOT a small business
      return not is_small_business
    else:
      # Fallback to simple check if NAICS data not available
      is_small_business = company.employee_count < 100 and company.annual_revenue < 10000000
      return not is_small_business
  
  def is_hipaa_applicable():
    """Determine if HIPAA applies - Enhanced with NAICS code analysis"""
    # First check NAICS code indication
    naics_suggests_hipaa = False
    if defined('company.naics_code') and company.naics_code:
      naics_suggests_hipaa = is_hipaa_applicable_by_naics(company.naics_code)
    
    # Combine NAICS indication with user responses
    user_indicates_hipaa = (is_hipaa_covered_entity or 
                           is_hipaa_business_associate or 
                           processes_phi)
    
    # HIPAA applies if either NAICS suggests it OR user confirmed it
    return naics_suggests_hipaa or user_indicates_hipaa
  
  def is_glba_applicable():
    """Determine if GLBA applies - Enhanced with NAICS code analysis"""
    # First check NAICS code indication
    naics_suggests_glba = False
    if defined('company.naics_code') and company.naics_code:
      naics_suggests_glba = is_glba_applicable_by_naics(company.naics_code)
    
    # Combine NAICS indication with user responses
    user_indicates_glba = (is_glba_financial_institution or 
                          (provides_financial_products and collects_npi))
    
    # GLBA applies if either NAICS suggests it OR user confirmed it
    return naics_suggests_glba or user_indicates_glba
---
code: |
  def load_requirements_for_jurisdictions():
    """Load detailed requirements for all applicable jurisdictions"""
    global jurisdiction_requirements
    jurisdiction_requirements = {}
    
    # For each applicable jurisdiction, use the imported objects
    for jurisdiction_id in applicable_jurisdictions:
      if jurisdiction_id == "gdpr":
        jurisdiction_requirements["gdpr"] = gdpr_requirements
      elif jurisdiction_id == "ccpa":
        jurisdiction_requirements["ccpa"] = ccpa_requirements
      elif jurisdiction_id == "tdpsa":
        jurisdiction_requirements["tdpsa"] = tdpsa_requirements
      # Note: HIPAA and GLBA would need their own JSON files if detailed requirements needed
    
    return jurisdiction_requirements
---
question: Applicable Privacy Laws
subquestion: |
  Based on your responses, the following privacy laws apply to your organization:
  
  % if not applicable_jurisdictions:
  **No privacy laws were found to be applicable based on the information provided.**
  
  This might be because your organization falls under small business exemptions or does not process personal data in jurisdictions with comprehensive privacy laws.
  % else:
  % for jurisdiction_id in applicable_jurisdictions:
  * **${ next((j["name"] for j in jurisdiction_registry["jurisdictions"] if j["id"] == jurisdiction_id), jurisdiction_id) }**
  % endfor
  
  % if "tdpsa" in applicable_jurisdictions:
  **Note**: TDPSA applicability was determined using SBA size standards for your NAICS code (${ company_naics_display }).
  % endif
  
  % if "hipaa" in applicable_jurisdictions and defined('company.naics_code'):
  **Note**: HIPAA applicability was indicated by your healthcare industry classification.
  % endif
  
  % if "glba" in applicable_jurisdictions and defined('company.naics_code'):
  **Note**: GLBA applicability was indicated by your financial services industry classification.
  % endif
  % endif
  
  These laws will determine the requirements for your privacy documentation and practices.
continue button field: applicable_law_continue
continue button label: "Continue to Current Practices Assessment"
---