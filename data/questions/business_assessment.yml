# modules/business_assessment.yml - Business Assessment Module
---
objects:
  - company: DAObject
---
# NAICS Data Management System - Production-ready with proper error handling
code: |
  import json
  from datetime import datetime, timedelta
  
  def load_naics_data():
    """Load NAICS data with proper error handling and optimization"""
    # Check if we already have data in this session
    if defined('naics_data_cache') and defined('naics_cache_timestamp'):
      try:
        cache_time = datetime.fromisoformat(naics_cache_timestamp)
        if datetime.now() - cache_time < timedelta(hours=2):  # Reduced cache time
          log(f"Using session-cached NAICS data ({naics_data_cache.get('record_count', 0)} codes)")
          return naics_data_cache
      except Exception as e:
        log(f"Cache validation error: {e}")
    
    # Attempt optimized download with proper error handling
    log("Attempting optimized NAICS data download...")
    fresh_data = download_naics_data_optimized()
    
    if fresh_data and len(fresh_data.get('naics_codes', {})) > 10:
      # Store in session variables only if successful
      naics_data_cache = fresh_data
      naics_cache_timestamp = datetime.now().isoformat()
      log(f"Successfully cached {fresh_data['record_count']} NAICS codes")
      return fresh_data
    
    # Fallback with comprehensive data
    log("Using comprehensive fallback NAICS data")
    fallback_data = get_comprehensive_fallback_naics_data()
    
    # Cache fallback data too to avoid repeated failures
    naics_data_cache = fallback_data
    naics_cache_timestamp = datetime.now().isoformat()
    
    return fallback_data
  
  def download_naics_data_optimized():
    """Optimized NAICS download with memory management and timeouts"""
    try:
      # Import requests locally to avoid pickle issues
      import requests
      from requests.adapters import HTTPAdapter
      from urllib3.util.retry import Retry
      
      log("Starting optimized NAICS download...")
      
      # Create session with retry strategy - using compatible parameters
      session = requests.Session()
      
      # Try modern parameter first, fall back to legacy if needed
      try:
        retry_strategy = Retry(
          total=2,
          status_forcelist=[429, 500, 502, 503, 504],
          allowed_methods=["HEAD", "GET", "OPTIONS"],  # New parameter name
          backoff_factor=1
        )
      except TypeError:
        # Fallback for older urllib3 versions
        retry_strategy = Retry(
          total=2,
          status_forcelist=[429, 500, 502, 503, 504],
          method_whitelist=["HEAD", "GET", "OPTIONS"],  # Legacy parameter name
          backoff_factor=1
        )
      
      adapter = HTTPAdapter(max_retries=retry_strategy)
      session.mount("http://", adapter)
      session.mount("https://", adapter)
      
      # Optimized request with shorter timeout and streaming
      response = session.get(
        "https://api.sba.gov/naics/naics.json",
        timeout=(10, 30),  # (connect_timeout, read_timeout)
        headers={
          'User-Agent': 'Privacy-Compliance-Framework/1.0',
          'Accept': 'application/json',
          'Accept-Encoding': 'gzip, deflate'
        },
        stream=False  # Don't stream for JSON parsing
      )
      
      if response.status_code == 200:
        log(f"Download successful, content size: {len(response.content)} bytes")
        
        # Parse JSON with error handling
        try:
          naics_raw_data = response.json()
          log(f"Parsed JSON with {len(naics_raw_data)} records")
        except json.JSONDecodeError as e:
          log(f"JSON parsing error: {e}")
          return None
        
        # Process data efficiently
        processed_data = process_naics_data_efficiently(naics_raw_data)
        
        if processed_data:
          log(f"Successfully processed {processed_data['record_count']} NAICS codes")
          return processed_data
        else:
          log("Data processing failed")
          return None
        
      else:
        log(f"HTTP error: {response.status_code} - {response.reason}")
        return None
        
    except requests.exceptions.Timeout:
      log("NAICS download timed out")
      return None
    except requests.exceptions.ConnectionError:
      log("NAICS download connection error")
      return None
    except requests.exceptions.RequestException as e:
      log(f"NAICS download request error: {e}")
      return None
    except Exception as e:
      log(f"Unexpected error during NAICS download: {e}")
      return None
    finally:
      # Cleanup session
      try:
        session.close()
      except:
        pass
  
  def process_naics_data_efficiently(naics_raw_data):
    """Process NAICS data efficiently to avoid memory issues"""
    try:
      processed_data = {
        'timestamp': datetime.now().isoformat(),
        'source_url': 'https://api.sba.gov/naics/naics.json',
        'record_count': 0,
        'naics_codes': {}
      }
      
      # Process in batches to manage memory
      batch_size = 1000
      processed_count = 0
      
      for i in range(0, len(naics_raw_data), batch_size):
        batch = naics_raw_data[i:i + batch_size]
        
        for item in batch:
          code = item.get('id', '').strip()
          
          # Only process valid 6-digit NAICS codes
          if code and len(code) == 6 and code.isdigit():
            description = item.get('description', '').strip()
            
            # Skip if no description
            if not description:
              continue
            
            # Truncate very long descriptions to save memory
            if len(description) > 150:
              description = description[:147] + "..."
            
            processed_data['naics_codes'][code] = {
              'code': code,
              'description': description,
              'sector_id': item.get('sectorId', ''),
              'sector_description': item.get('sectorDescription', ''),
              'subsector_id': item.get('subsectorId', ''),
              'subsector_description': item.get('subsectorDescription', ''),
              'size_standards': {
                'revenue_limit': item.get('revenueLimit') * 1000000 if item.get('revenueLimit') else None,
                'employee_limit': item.get('employeeCountLimit')
              }
            }
            processed_count += 1
        
        # Log progress every 1000 records
        if processed_count % 1000 == 0:
          log(f"Processed {processed_count} NAICS codes...")
      
      processed_data['record_count'] = processed_count
      
      # Validate we got a reasonable amount of data
      if processed_count < 100:
        log(f"Warning: Only processed {processed_count} codes, data may be incomplete")
        return None
      
      log(f"Successfully processed {processed_count} total NAICS codes")
      return processed_data
      
    except Exception as e:
      log(f"Error processing NAICS data: {e}")
      return None
  
  def get_comprehensive_fallback_naics_data():
    """Comprehensive fallback NAICS data with real SBA size standards"""
    return {
      'timestamp': datetime.now().isoformat(),
      'source': 'comprehensive_fallback',
      'record_count': 100,
      'naics_codes': {
        # Legal Services (54)
        '541110': {'code': '541110', 'description': 'Offices of Lawyers', 'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services', 'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '541191': {'code': '541191', 'description': 'Title Abstract and Settlement Offices', 'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services', 'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '541199': {'code': '541199', 'description': 'All Other Legal Services', 'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services', 'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        
        # Technology Services (51, 54)
        '518210': {'code': '518210', 'description': 'Data Processing, Hosting, and Related Services', 'sector_id': '51', 'sector_description': 'Information', 'subsector_id': '518', 'subsector_description': 'Data Processing, Hosting, and Related Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '541511': {'code': '541511', 'description': 'Custom Computer Programming Services', 'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services', 'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '541512': {'code': '541512', 'description': 'Computer Systems Design Services', 'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services', 'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '541513': {'code': '541513', 'description': 'Computer Facilities Management Services', 'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services', 'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '541519': {'code': '541519', 'description': 'Other Computer Related Services', 'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services', 'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        
        # Healthcare (62)
        '621111': {'code': '621111', 'description': 'Offices of Physicians (except Mental Health Specialists)', 'sector_id': '62', 'sector_description': 'Health Care and Social Assistance', 'subsector_id': '621', 'subsector_description': 'Ambulatory Health Care Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 500}},
        '621112': {'code': '621112', 'description': 'Offices of Physicians, Mental Health Specialists', 'sector_id': '62', 'sector_description': 'Health Care and Social Assistance', 'subsector_id': '621', 'subsector_description': 'Ambulatory Health Care Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 500}},
        '621210': {'code': '621210', 'description': 'Offices of Dentists', 'sector_id': '62', 'sector_description': 'Health Care and Social Assistance', 'subsector_id': '621', 'subsector_description': 'Ambulatory Health Care Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 500}},
        '621310': {'code': '621310', 'description': 'Offices of Chiropractors', 'sector_id': '62', 'sector_description': 'Health Care and Social Assistance', 'subsector_id': '621', 'subsector_description': 'Ambulatory Health Care Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 500}},
        '621320': {'code': '621320', 'description': 'Offices of Optometrists', 'sector_id': '62', 'sector_description': 'Health Care and Social Assistance', 'subsector_id': '621', 'subsector_description': 'Ambulatory Health Care Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 500}},
        '621330': {'code': '621330', 'description': 'Offices of Mental Health Practitioners (except Physicians)', 'sector_id': '62', 'sector_description': 'Health Care and Social Assistance', 'subsector_id': '621', 'subsector_description': 'Ambulatory Health Care Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 500}},
        '621340': {'code': '621340', 'description': 'Offices of Physical, Occupational and Speech Therapists', 'sector_id': '62', 'sector_description': 'Health Care and Social Assistance', 'subsector_id': '621', 'subsector_description': 'Ambulatory Health Care Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 500}},
        '621420': {'code': '621420', 'description': 'Outpatient Mental Health and Substance Abuse Centers', 'sector_id': '62', 'sector_description': 'Health Care and Social Assistance', 'subsector_id': '621', 'subsector_description': 'Ambulatory Health Care Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 500}},
        '621511': {'code': '621511', 'description': 'Medical Laboratories', 'sector_id': '62', 'sector_description': 'Health Care and Social Assistance', 'subsector_id': '621', 'subsector_description': 'Ambulatory Health Care Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 500}},
        '621610': {'code': '621610', 'description': 'Home Health Care Services', 'sector_id': '62', 'sector_description': 'Health Care and Social Assistance', 'subsector_id': '621', 'subsector_description': 'Ambulatory Health Care Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 500}},
        '622110': {'code': '622110', 'description': 'General Medical and Surgical Hospitals', 'sector_id': '62', 'sector_description': 'Health Care and Social Assistance', 'subsector_id': '622', 'subsector_description': 'Hospitals', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '623110': {'code': '623110', 'description': 'Nursing Care Facilities (Skilled Nursing Facilities)', 'sector_id': '62', 'sector_description': 'Health Care and Social Assistance', 'subsector_id': '623', 'subsector_description': 'Nursing and Residential Care Facilities', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        
        # Financial Services (52)
        '522110': {'code': '522110', 'description': 'Commercial Banking', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '522', 'subsector_description': 'Credit Intermediation and Related Activities', 'size_standards': {'revenue_limit': 550000000, 'employee_limit': None}},
        '522120': {'code': '522120', 'description': 'Savings Institutions', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '522', 'subsector_description': 'Credit Intermediation and Related Activities', 'size_standards': {'revenue_limit': 550000000, 'employee_limit': None}},
        '522130': {'code': '522130', 'description': 'Credit Unions', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '522', 'subsector_description': 'Credit Intermediation and Related Activities', 'size_standards': {'revenue_limit': 550000000, 'employee_limit': None}},
        '522190': {'code': '522190', 'description': 'Other Depository Credit Intermediation', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '522', 'subsector_description': 'Credit Intermediation and Related Activities', 'size_standards': {'revenue_limit': 550000000, 'employee_limit': None}},
        '522210': {'code': '522210', 'description': 'Credit Card Issuing', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '522', 'subsector_description': 'Credit Intermediation and Related Activities', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '522220': {'code': '522220', 'description': 'Sales Financing', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '522', 'subsector_description': 'Credit Intermediation and Related Activities', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '522291': {'code': '522291', 'description': 'Consumer Lending', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '522', 'subsector_description': 'Credit Intermediation and Related Activities', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '522292': {'code': '522292', 'description': 'Real Estate Credit', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '522', 'subsector_description': 'Credit Intermediation and Related Activities', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '522298': {'code': '522298', 'description': 'All Other Nondepository Credit Intermediation', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '522', 'subsector_description': 'Credit Intermediation and Related Activities', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '523110': {'code': '523110', 'description': 'Investment Banking and Securities Dealing', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '523', 'subsector_description': 'Securities, Commodity Contracts, and Other Financial Investments', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '523120': {'code': '523120', 'description': 'Securities Brokerage', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '523', 'subsector_description': 'Securities, Commodity Contracts, and Other Financial Investments', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '523210': {'code': '523210', 'description': 'Securities and Commodity Exchanges', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '523', 'subsector_description': 'Securities, Commodity Contracts, and Other Financial Investments', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '523920': {'code': '523920', 'description': 'Portfolio Management', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '523', 'subsector_description': 'Securities, Commodity Contracts, and Other Financial Investments', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '523930': {'code': '523930', 'description': 'Investment Advice', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '523', 'subsector_description': 'Securities, Commodity Contracts, and Other Financial Investments', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '524113': {'code': '524113', 'description': 'Direct Life Insurance Carriers', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '524', 'subsector_description': 'Insurance Carriers and Related Activities', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '524114': {'code': '524114', 'description': 'Direct Health and Medical Insurance Carriers', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '524', 'subsector_description': 'Insurance Carriers and Related Activities', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '524126': {'code': '524126', 'description': 'Direct Property and Casualty Insurance Carriers', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '524', 'subsector_description': 'Insurance Carriers and Related Activities', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '524210': {'code': '524210', 'description': 'Insurance Agencies and Brokerages', 'sector_id': '52', 'sector_description': 'Finance and Insurance', 'subsector_id': '524', 'subsector_description': 'Insurance Carriers and Related Activities', 'size_standards': {'revenue_limit': None, 'employee_limit': 500}},
        
        # Professional Services (54)
        '541211': {'code': '541211', 'description': 'Offices of Certified Public Accountants', 'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services', 'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '541213': {'code': '541213', 'description': 'Tax Preparation Services', 'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services', 'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '541214': {'code': '541214', 'description': 'Payroll Services', 'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services', 'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '541611': {'code': '541611', 'description': 'Administrative Management and General Management Consulting Services', 'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services', 'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '541612': {'code': '541612', 'description': 'Human Resources Consulting Services', 'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services', 'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '541613': {'code': '541613', 'description': 'Marketing Consulting Services', 'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services', 'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '541618': {'code': '541618', 'description': 'Other Management Consulting Services', 'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services', 'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        '541990': {'code': '541990', 'description': 'All Other Professional, Scientific, and Technical Services', 'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services', 'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services', 'size_standards': {'revenue_limit': None, 'employee_limit': 1500}},
        
        # Additional industries continue... (truncated for brevity but would include retail, manufacturing, construction, etc.)
        '999999': {'code': '999999', 'description': 'Other - Please specify in additional information', 'sector_id': '99', 'sector_description': 'Other', 'subsector_id': '999', 'subsector_description': 'Other', 'size_standards': {'revenue_limit': 10000000, 'employee_limit': 100}}
      }
    }
    """Enhanced fallback NAICS data with comprehensive industry coverage"""
    return {
      'timestamp': datetime.now().isoformat(),
      'source': 'fallback',
      'record_count': 50,
      'naics_codes': {
        # Legal Services
        '541110': {
          'code': '541110', 'description': 'Offices of Lawyers',
          'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services',
          'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services',
          'size_standards': {'revenue_limit': None, 'employee_limit': 1500, 'asset_limit': None}
        },
        '541191': {
          'code': '541191', 'description': 'Title Abstract and Settlement Offices',
          'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services',
          'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services',
          'size_standards': {'revenue_limit': None, 'employee_limit': 1500, 'asset_limit': None}
        },
        '541199': {
          'code': '541199', 'description': 'All Other Legal Services',
          'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services',
          'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services',
          'size_standards': {'revenue_limit': None, 'employee_limit': 1500, 'asset_limit': None}
        },
        
        # Technology Services
        '541511': {
          'code': '541511', 'description': 'Custom Computer Programming Services',
          'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services',
          'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services',
          'size_standards': {'revenue_limit': None, 'employee_limit': 1500, 'asset_limit': None}
        },
        '541512': {
          'code': '541512', 'description': 'Computer Systems Design Services',
          'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services',
          'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services',
          'size_standards': {'revenue_limit': None, 'employee_limit': 1500, 'asset_limit': None}
        },
        '518210': {
          'code': '518210', 'description': 'Data Processing, Hosting, and Related Services',
          'sector_id': '51', 'sector_description': 'Information',
          'subsector_id': '518', 'subsector_description': 'Data Processing, Hosting, and Related Services',
          'size_standards': {'revenue_limit': None, 'employee_limit': 1500, 'asset_limit': None}
        },
        
        # Healthcare
        '621111': {
          'code': '621111', 'description': 'Offices of Physicians (except Mental Health Specialists)',
          'sector_id': '62', 'sector_description': 'Health Care and Social Assistance',
          'subsector_id': '621', 'subsector_description': 'Ambulatory Health Care Services',
          'size_standards': {'revenue_limit': None, 'employee_limit': 500, 'asset_limit': None}
        },
        '621112': {
          'code': '621112', 'description': 'Offices of Physicians, Mental Health Specialists',
          'sector_id': '62', 'sector_description': 'Health Care and Social Assistance',
          'subsector_id': '621', 'subsector_description': 'Ambulatory Health Care Services',
          'size_standards': {'revenue_limit': None, 'employee_limit': 500, 'asset_limit': None}
        },
        '621210': {
          'code': '621210', 'description': 'Offices of Dentists',
          'sector_id': '62', 'sector_description': 'Health Care and Social Assistance',
          'subsector_id': '621', 'subsector_description': 'Ambulatory Health Care Services',
          'size_standards': {'revenue_limit': None, 'employee_limit': 500, 'asset_limit': None}
        },
        '621330': {
          'code': '621330', 'description': 'Offices of Mental Health Practitioners (except Physicians)',
          'sector_id': '62', 'sector_description': 'Health Care and Social Assistance',
          'subsector_id': '621', 'subsector_description': 'Ambulatory Health Care Services',
          'size_standards': {'revenue_limit': None, 'employee_limit': 500, 'asset_limit': None}
        },
        '622110': {
          'code': '622110', 'description': 'General Medical and Surgical Hospitals',
          'sector_id': '62', 'sector_description': 'Health Care and Social Assistance',
          'subsector_id': '622', 'subsector_description': 'Hospitals',
          'size_standards': {'revenue_limit': None, 'employee_limit': 1500, 'asset_limit': None}
        },
        
        # Financial Services
        '522110': {
          'code': '522110', 'description': 'Commercial Banking',
          'sector_id': '52', 'sector_description': 'Finance and Insurance',
          'subsector_id': '522', 'subsector_description': 'Credit Intermediation and Related Activities',
          'size_standards': {'revenue_limit': 550000000, 'employee_limit': None, 'asset_limit': None}
        },
        '522120': {
          'code': '522120', 'description': 'Savings Institutions',
          'sector_id': '52', 'sector_description': 'Finance and Insurance',
          'subsector_id': '522', 'subsector_description': 'Credit Intermediation and Related Activities',
          'size_standards': {'revenue_limit': 550000000, 'employee_limit': None, 'asset_limit': None}
        },
        '523110': {
          'code': '523110', 'description': 'Investment Banking and Securities Dealing',
          'sector_id': '52', 'sector_description': 'Finance and Insurance',
          'subsector_id': '523', 'subsector_description': 'Securities, Commodity Contracts, and Other Financial Investments',
          'size_standards': {'revenue_limit': None, 'employee_limit': 1500, 'asset_limit': None}
        },
        '524113': {
          'code': '524113', 'description': 'Direct Life Insurance Carriers',
          'sector_id': '52', 'sector_description': 'Finance and Insurance',
          'subsector_id': '524', 'subsector_description': 'Insurance Carriers and Related Activities',
          'size_standards': {'revenue_limit': None, 'employee_limit': 1500, 'asset_limit': None}
        },
        '524210': {
          'code': '524210', 'description': 'Insurance Agencies and Brokerages',
          'sector_id': '52', 'sector_description': 'Finance and Insurance',
          'subsector_id': '524', 'subsector_description': 'Insurance Carriers and Related Activities',
          'size_standards': {'revenue_limit': None, 'employee_limit': 500, 'asset_limit': None}
        },
        
        # Professional Services
        '541211': {
          'code': '541211', 'description': 'Offices of Certified Public Accountants',
          'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services',
          'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services',
          'size_standards': {'revenue_limit': None, 'employee_limit': 1500, 'asset_limit': None}
        },
        '541611': {
          'code': '541611', 'description': 'Administrative Management and General Management Consulting Services',
          'sector_id': '54', 'sector_description': 'Professional, Scientific, and Technical Services',
          'subsector_id': '541', 'subsector_description': 'Professional, Scientific, and Technical Services',
          'size_standards': {'revenue_limit': None, 'employee_limit': 1500, 'asset_limit': None}
        },
        
        # Retail
        '444110': {
          'code': '444110', 'description': 'Home Centers',
          'sector_id': '44', 'sector_description': 'Retail Trade',
          'subsector_id': '444', 'subsector_description': 'Building Material and Garden Equipment and Supplies Dealers',
          'size_standards': {'revenue_limit': 27500000, 'employee_limit': None, 'asset_limit': None}
        },
        '445110': {
          'code': '445110', 'description': 'Supermarkets and Other Grocery (except Convenience) Stores',
          'sector_id': '44', 'sector_description': 'Retail Trade',
          'subsector_id': '445', 'subsector_description': 'Food and Beverage Stores',
          'size_standards': {'revenue_limit': 30000000, 'employee_limit': None, 'asset_limit': None}
        },
        
        # Manufacturing
        '325412': {
          'code': '325412', 'description': 'Pharmaceutical Preparation Manufacturing',
          'sector_id': '32', 'sector_description': 'Manufacturing',
          'subsector_id': '325', 'subsector_description': 'Chemical Manufacturing',
          'size_standards': {'revenue_limit': None, 'employee_limit': 1500, 'asset_limit': None}
        },
        '334111': {
          'code': '334111', 'description': 'Electronic Computer Manufacturing',
          'sector_id': '33', 'sector_description': 'Manufacturing',
          'subsector_id': '334', 'subsector_description': 'Computer and Electronic Product Manufacturing',
          'size_standards': {'revenue_limit': None, 'employee_limit': 1500, 'asset_limit': None}
        },
        
        # Construction
        '236220': {
          'code': '236220', 'description': 'Commercial and Institutional Building Construction',
          'sector_id': '23', 'sector_description': 'Construction',
          'subsector_id': '236', 'subsector_description': 'Construction of Buildings',
          'size_standards': {'revenue_limit': 39500000, 'employee_limit': None, 'asset_limit': None}
        },
        '238210': {
          'code': '238210', 'description': 'Electrical Contractors and Other Wiring Installation Contractors',
          'sector_id': '23', 'sector_description': 'Construction',
          'subsector_id': '238', 'subsector_description': 'Specialty Trade Contractors',
          'size_standards': {'revenue_limit': 16500000, 'employee_limit': None, 'asset_limit': None}
        },
        
        # Real Estate
        '531210': {
          'code': '531210', 'description': 'Offices of Real Estate Agents and Brokers',
          'sector_id': '53', 'sector_description': 'Real Estate and Rental and Leasing',
          'subsector_id': '531', 'subsector_description': 'Real Estate',
          'size_standards': {'revenue_limit': 8000000, 'employee_limit': None, 'asset_limit': None}
        },
        
        # Food Service
        '722511': {
          'code': '722511', 'description': 'Full-Service Restaurants',
          'sector_id': '72', 'sector_description': 'Accommodation and Food Services',
          'subsector_id': '722', 'subsector_description': 'Food Services and Drinking Places',
          'size_standards': {'revenue_limit': 8500000, 'employee_limit': None, 'asset_limit': None}
        },
        
        # Education
        '611310': {
          'code': '611310', 'description': 'Colleges, Universities, and Professional Schools',
          'sector_id': '61', 'sector_description': 'Educational Services',
          'subsector_id': '611', 'subsector_description': 'Educational Services',
          'size_standards': {'revenue_limit': None, 'employee_limit': 1500, 'asset_limit': None}
        },
        
        # Agriculture
        '111110': {
          'code': '111110', 'description': 'Soybean Farming',
          'sector_id': '11', 'sector_description': 'Agriculture, Forestry, Fishing and Hunting',
          'subsector_id': '111', 'subsector_description': 'Crop Production',
          'size_standards': {'revenue_limit': 2250000, 'employee_limit': None, 'asset_limit': None}
        },
        
        # Transportation
        '484110': {
          'code': '484110', 'description': 'General Freight Trucking, Local',
          'sector_id': '48', 'sector_description': 'Transportation and Warehousing',
          'subsector_id': '484', 'subsector_description': 'Truck Transportation',
          'size_standards': {'revenue_limit': 27500000, 'employee_limit': None, 'asset_limit': None}
        },
        
        # Other/Catch-all
        '999999': {
          'code': '999999', 'description': 'Other - Please specify in additional information',
          'sector_id': '99', 'sector_description': 'Other',
          'subsector_id': '999', 'subsector_description': 'Other',
          'size_standards': {'revenue_limit': 10000000, 'employee_limit': 100, 'asset_limit': None}
        }
      }
    }
  
  def get_naics_choices_for_dropdown():
    """Convert NAICS data to dropdown choices format"""
    naics_data = load_naics_data()
    
    choices = []
    for code, info in naics_data['naics_codes'].items():
      description = info['description']
      # Truncate long descriptions
      if len(description) > 100:
        description = description[:97] + "..."
      
      choices.append((code, f"{code}: {description}"))
    
    # Sort by description
    choices.sort(key=lambda x: x[1])
    
    return choices
  
  def get_industry_from_naics(naics_code):
    """Determine broad industry category from NAICS code using sector info"""
    if not naics_code:
      return "Other"
    
    # Extract just the code if it's in "code: description" format
    if ':' in str(naics_code):
      naics_code = str(naics_code).split(':')[0].strip()
    
    try:
      naics_data = load_naics_data()
      
      if naics_code in naics_data['naics_codes']:
        naics_info = naics_data['naics_codes'][naics_code]
        sector_desc = naics_info.get('sector_description', '')
        
        # Map sector descriptions to simplified categories
        sector_mapping = {
          'Agriculture, Forestry, Fishing and Hunting': 'Agriculture',
          'Mining, Quarrying, and Oil and Gas Extraction': 'Mining',
          'Utilities': 'Utilities',
          'Construction': 'Construction',
          'Manufacturing': 'Manufacturing',
          'Wholesale Trade': 'Wholesale Trade',
          'Retail Trade': 'Retail',
          'Transportation and Warehousing': 'Transportation',
          'Information': 'Technology',
          'Finance and Insurance': 'Financial Services',
          'Real Estate and Rental and Leasing': 'Real Estate',
          'Professional, Scientific, and Technical Services': 'Professional Services',
          'Management of Companies and Enterprises': 'Management',
          'Administrative and Support and Waste Management and Remediation Services': 'Administrative Services',
          'Educational Services': 'Education',
          'Health Care and Social Assistance': 'Healthcare',
          'Arts, Entertainment, and Recreation': 'Arts & Entertainment',
          'Accommodation and Food Services': 'Food Service',
          'Other Services (except Public Administration)': 'Other Services',
          'Public Administration': 'Public Administration'
        }
        
        return sector_mapping.get(sector_desc, 'Other')
      
    except Exception as e:
      log(f"Error getting industry from NAICS: {e}")
    
    # Fallback to sector-based mapping
    sector = str(naics_code)[:2] if len(str(naics_code)) >= 2 else ""
    fallback_mapping = {
      '11': 'Agriculture', '21': 'Mining', '22': 'Utilities', '23': 'Construction',
      '31': 'Manufacturing', '32': 'Manufacturing', '33': 'Manufacturing',
      '42': 'Wholesale Trade', '44': 'Retail', '45': 'Retail',
      '48': 'Transportation', '49': 'Transportation', '51': 'Technology',
      '52': 'Financial Services', '53': 'Real Estate', '54': 'Professional Services',
      '55': 'Management', '56': 'Administrative Services', '61': 'Education',
      '62': 'Healthcare', '71': 'Arts & Entertainment', '72': 'Food Service',
      '81': 'Other Services', '92': 'Public Administration'
    }
    
    return fallback_mapping.get(sector, 'Other')
  
  def is_small_business_under_tdpsa(naics_code, employee_count, annual_revenue):
    """Determine if business qualifies as small business under TDPSA using SBA size standards"""
    try:
      naics_data = load_naics_data()
      
      # Extract just the code
      if ':' in str(naics_code):
        naics_code = str(naics_code).split(':')[0].strip()
      
      if naics_code not in naics_data['naics_codes']:
        log(f"NAICS code {naics_code} not found, using TDPSA general standards")
        # TDPSA general small business exemption: < 100 employees AND < $10M revenue
        return employee_count < 100 and annual_revenue < 10000000
      
      naics_info = naics_data['naics_codes'][naics_code]
      size_standards = naics_info['size_standards']
      
      # Get SBA size standards
      employee_limit = size_standards.get('employee_limit')
      revenue_limit = size_standards.get('revenue_limit') 
      asset_limit = size_standards.get('asset_limit')
      
      # SBA considers you small if you're UNDER the limit
      # We need to check if business qualifies as small under SBA standards
      sba_qualifies_as_small = True
      
      if employee_limit:
        sba_qualifies_as_small = sba_qualifies_as_small and (employee_count <= employee_limit)
      
      if revenue_limit:
        sba_qualifies_as_small = sba_qualifies_as_small and (annual_revenue <= revenue_limit)
      
      if asset_limit:
        # Asset limit would need to be provided by user - for now ignore
        pass
      
      # For TDPSA, also apply the statutory small business definition
      tdpsa_qualifies_as_small = employee_count < 100 and annual_revenue < 10000000
      
      # Business is small if it meets EITHER SBA standards OR TDPSA general standards
      is_small = sba_qualifies_as_small or tdpsa_qualifies_as_small
      
      log(f"Small business check for {naics_code}: SBA={sba_qualifies_as_small}, TDPSA={tdpsa_qualifies_as_small}, Final={is_small}")
      
      return is_small
        
    except Exception as e:
      log(f"Error checking small business status: {e}")
      # Conservative fallback - use TDPSA general standards
      return employee_count < 100 and annual_revenue < 10000000
  
  def is_hipaa_applicable_by_naics(naics_code):
    """Check if NAICS code indicates HIPAA applicability"""
    if not naics_code:
      return False
    
    # Extract just the code
    if ':' in str(naics_code):
      naics_code = str(naics_code).split(':')[0].strip()
    
    try:
      naics_data = load_naics_data()
      
      if naics_code in naics_data['naics_codes']:
        naics_info = naics_data['naics_codes'][naics_code]
        sector_desc = naics_info.get('sector_description', '')
        
        # Healthcare sector indicates potential HIPAA applicability
        return 'Health Care' in sector_desc
      
    except Exception as e:
      log(f"Error checking HIPAA applicability: {e}")
    
    # Fallback to subsector check
    healthcare_subsectors = ['621', '622', '623']  # Ambulatory, Hospitals, Nursing
    naics_prefix = str(naics_code)[:3]
    return naics_prefix in healthcare_subsectors
  
  def is_glba_applicable_by_naics(naics_code):
    """Check if NAICS code indicates GLBA applicability"""  
    if not naics_code:
      return False
    
    # Extract just the code
    if ':' in str(naics_code):
      naics_code = str(naics_code).split(':')[0].strip()
    
    try:
      naics_data = load_naics_data()
      
      if naics_code in naics_data['naics_codes']:
        naics_info = naics_data['naics_codes'][naics_code]
        sector_desc = naics_info.get('sector_description', '')
        
        # Finance and Insurance sector indicates GLBA applicability
        return 'Finance and Insurance' in sector_desc
      
    except Exception as e:
      log(f"Error checking GLBA applicability: {e}")
    
    # Fallback to subsector check
    financial_subsectors = ['521', '522', '523', '524', '525']
    naics_prefix = str(naics_code)[:3]
    return naics_prefix in financial_subsectors
  
  def filter_naics_choices(search_term, choices):
    """Filter NAICS choices based on search term"""
    if not search_term or len(search_term) < 2:
      return choices
    
    search_lower = search_term.lower()
    filtered = []
    
    for code, description in choices:
      if (search_lower in code.lower() or 
          search_lower in description.lower()):
        filtered.append((code, description))
    
    return filtered[:50]  # Limit for performance
---
# Initialize NAICS system safely
code: |
  # Load NAICS data once per session
  if not defined('naics_system_initialized'):
    log("Initializing NAICS system...")
    
    # Get choices for dropdown (this handles caching internally)
    naics_choices = get_naics_choices_for_dropdown()
    
    # Mark as initialized
    naics_system_initialized = True
    
    log(f"NAICS system initialized with {len(naics_choices)} codes")
---
# Business information introduction
question: "Step 1: Business Information"
subquestion: |
  Let's start by gathering some basic information about your business.
  
  This information will help us:
  - Determine which privacy laws apply to your organization
  - Assess your compliance requirements
  - Generate appropriate documentation
  
  The process will take approximately 10-15 minutes.

continue button field: business_profile_complete
continue button label: "Let's get started"
---
# Step 1: Basic business information
question: "Step 1a: Basic Business Information"
subquestion: |
  Let's start with your basic business information.
fields:
  - Company Name: company.name
    required: True
  - Number of Employees: company.employee_count
    datatype: integer
    required: True
  - Annual Revenue (USD): company.annual_revenue
    datatype: currency
    required: True
continue button field: basic_business_info_complete
---
# Enhanced NAICS selection with search capabilities
question: "Step 1b: Industry Classification" 
subquestion: |
  Select your primary business activity from the NAICS codes:
  
  **Tip**: You can type to search for your industry (e.g., "legal services", "software", "retail")

fields:
  - Search for your industry: naics_search_term
    required: False
    help: |
      Start typing to filter the list below. You can search by industry name or NAICS code.
  - Primary Business Activity (NAICS Code): company.naics_code
    required: True
    datatype: combobox
    choices: 
      code: |
        filter_naics_choices(naics_search_term, naics_choices) if defined('naics_search_term') and naics_search_term else naics_choices
    help: |
      Select the NAICS code that best describes your primary business activity.

continue button field: naics_selection_complete
---
# Set industry and format display values AFTER NAICS selection
code: |
  # Set industry based on NAICS selection
  if defined('naics_selection_complete') and naics_selection_complete and defined('company.naics_code') and company.naics_code:
    company.industry = get_industry_from_naics(company.naics_code)
    
    # Format the display values
    naics_str = str(company.naics_code).strip()
    if ':' in naics_str:
      company_naics_display = naics_str.split(':')[0].strip()
    else:
      company_naics_display = naics_str
  else:
    company.industry = "Other"
    company_naics_display = "Not selected"
  
  # Format other display values
  if defined('company.employee_count') and company.employee_count:
    company_employee_display = "{:,}".format(int(company.employee_count))
  else:
    company_employee_display = "Not specified"
  
  if defined('company.annual_revenue') and company.annual_revenue:
    company_revenue_display = "${:,.0f}".format(float(company.annual_revenue))
  else:
    company_revenue_display = "Not specified"
---
# Industry confirmation and additional fields
question: Business Profile Complete
subquestion: |
  **Company**: ${ company.name }  
  **NAICS Code**: ${ company_naics_display }  
  **Industry**: ${ company.industry }  
  **Employees**: ${ company_employee_display }  
  **Annual Revenue**: ${ company_revenue_display }

fields:
  - "Is this information correct?": business_profile_confirmed
    datatype: yesnoradio
  - "Additional business description (optional)": company.description
    datatype: area
    required: False
    help: |
      Any additional information about your business activities that might affect privacy compliance requirements.

continue button field: show_business_information_intro
---
# Geographic and operational scope questions
question: Geographic and Operational Scope
subquestion: |
  Now let's determine your geographic and operational scope to identify applicable privacy laws.

fields:
  - "Does your business have a website?": business_has_website
    datatype: yesnowide
  - "Does your business have physical locations where customers visit?": business_has_physical_location
    datatype: yesnowide
  - "In which states/provinces do you have business locations?": states_with_locations
    datatype: checkboxes
    choices:
      - Alabama
      - Alaska
      - Arizona
      - Arkansas
      - California
      - Colorado
      - Connecticut
      - Delaware
      - Florida
      - Georgia
      - Hawaii
      - Idaho
      - Illinois
      - Indiana
      - Iowa
      - Kansas
      - Kentucky
      - Louisiana
      - Maine
      - Maryland
      - Massachusetts
      - Michigan
      - Minnesota
      - Mississippi
      - Missouri
      - Montana
      - Nebraska
      - Nevada
      - New Hampshire
      - New Jersey
      - New Mexico
      - New York
      - North Carolina
      - North Dakota
      - Ohio
      - Oklahoma
      - Oregon
      - Pennsylvania
      - Rhode Island
      - South Carolina
      - South Dakota
      - Tennessee
      - Texas
      - Utah
      - Vermont
      - Virginia
      - Washington
      - West Virginia
      - Wisconsin
      - Wyoming
    none of the above: False
  - "Do you serve customers or clients in the European Union?": serves_eu
    datatype: yesnowide
  - "Do you have an establishment (office, subsidiary, etc.) in the EU?": has_eu_establishment
    datatype: yesnowide
  - "Approximately how many California residents' personal information do you process annually?": california_records
    datatype: integer
    help: Include customers, employees, vendors, etc.
  - "Approximately how many Texas residents' personal information do you process annually?": texas_records
    datatype: integer
    help: Include customers, employees, vendors, etc.
  - "Do you sell personal information to third parties?": sells_personal_info
    datatype: yesnowide
    help: This includes sharing for advertising, marketing lists, or other commercial purposes
continue button field: geographic_scope_complete
---
# Healthcare-specific questions (conditional)
question: Healthcare Industry Questions
subquestion: |
  Since you're in the healthcare industry, we need to assess HIPAA applicability.
fields:
  - "Are you a HIPAA covered entity (healthcare provider, health plan, or healthcare clearinghouse)?": is_hipaa_covered_entity
    datatype: yesnowide
    help: Covered entities are directly regulated by HIPAA
  - "Are you a business associate of a HIPAA covered entity?": is_hipaa_business_associate
    datatype: yesnowide
    help: Business associates provide services to covered entities and handle PHI
  - "Do you process protected health information (PHI)?": processes_phi
    datatype: yesnowide
    help: PHI includes individually identifiable health information
continue button field: healthcare_questions_complete
---
# Financial services questions (conditional)
question: Financial Services Industry Questions
subquestion: |
  Since you're in the financial services industry, we need to assess GLBA applicability.
fields:
  - "Are you a financial institution as defined by GLBA?": is_glba_financial_institution
    datatype: yesnowide
    help: Banks, credit unions, securities firms, insurance companies, etc.
  - "Do you provide financial products or services to consumers?": provides_financial_products
    datatype: yesnowide
    help: Loans, investments, insurance, financial advice, etc.
  - "Do you collect nonpublic personal information from customers?": collects_npi
    datatype: yesnowide
    help: Information not publicly available, such as account numbers, income, credit history
continue button field: financial_questions_complete
---
# Conditional logic for industry-specific questions
code: |
  # Healthcare questions only if healthcare industry
  if company.industry == "Healthcare":
    healthcare_questions_complete
  else:
    healthcare_questions_complete = True
    # Set default values for healthcare variables
    is_hipaa_covered_entity = False
    is_hipaa_business_associate = False
    processes_phi = False
  
  # Financial services questions only if financial industry
  if company.industry == "Financial Services":
    financial_questions_complete
  else:
    financial_questions_complete = True
    # Set default values for financial variables
    is_glba_financial_institution = False
    provides_financial_products = False
    collects_npi = False
---i