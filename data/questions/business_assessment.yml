# modules/business_assessment.yml - Business Assessment Module
---
objects:
  - company: DAObject
---
# Initialize all variables to prevent 'null' errors
code: |
  # Initialize all business assessment variables
  if not defined('business_profile_complete'):
    business_profile_complete = False
  if not defined('basic_business_info_complete'):
    basic_business_info_complete = False
  if not defined('naics_selection_complete'):
    naics_selection_complete = False
  if not defined('business_profile_confirmed'):
    business_profile_confirmed = False
  if not defined('geographic_scope_complete'):
    geographic_scope_complete = False
  if not defined('healthcare_questions_complete'):
    healthcare_questions_complete = False
  if not defined('financial_questions_complete'):
    financial_questions_complete = False
  
  # Initialize company object attributes
  if not defined('company.name'):
    company.name = ''
  if not defined('company.employee_count'):
    company.employee_count = 0
  if not defined('company.annual_revenue'):
    company.annual_revenue = 0
  if not defined('company.naics_code'):
    company.naics_code = ''
  if not defined('company.industry'):
    company.industry = 'Other'
  if not defined('company.description'):
    company.description = ''
  
  # Initialize geographic variables
  if not defined('business_has_website'):
    business_has_website = False
  if not defined('business_has_physical_location'):
    business_has_physical_location = False
  if not defined('states_with_locations'):
    states_with_locations = []
  if not defined('serves_eu'):
    serves_eu = False
  if not defined('has_eu_establishment'):
    has_eu_establishment = False
  if not defined('california_records'):
    california_records = 0
  if not defined('texas_records'):
    texas_records = 0
  if not defined('sells_personal_info'):
    sells_personal_info = False
  
  # Initialize healthcare variables
  if not defined('is_hipaa_covered_entity'):
    is_hipaa_covered_entity = False
  if not defined('is_hipaa_business_associate'):
    is_hipaa_business_associate = False
  if not defined('processes_phi'):
    processes_phi = False
  
  # Initialize financial variables
  if not defined('is_glba_financial_institution'):
    is_glba_financial_institution = False
  if not defined('provides_financial_products'):
    provides_financial_products = False
  if not defined('collects_npi'):
    collects_npi = False
  
  # Initialize display variables
  if not defined('company_naics_display'):
    company_naics_display = 'Not selected'
  if not defined('company_employee_display'):
    company_employee_display = 'Not specified'
  if not defined('company_revenue_display'):
    company_revenue_display = 'Not specified'
---
modules:
  - requests
  - threading
  - json
  - os
---
# ALL FUNCTION DEFINITIONS FIRST - This fixes the "function not defined" errors
code: |
  import json
  import os
  from datetime import datetime, timedelta
  
  def get_cached_naics_choices(cache_days=7):
    """Get NAICS choices from local cache if fresh"""
    cache_file = 'naics_choices_cache.json'
    
    try:
      if os.path.exists(cache_file):
        with open(cache_file, 'r') as f:
          cache_data = json.load(f)
        
        cache_time = datetime.fromisoformat(cache_data['timestamp'])
        if datetime.now() - cache_time < timedelta(days=cache_days):
          log(f"Using cached NAICS choices ({len(cache_data['choices'])} items, cached {cache_time})")
          return cache_data['choices']
        else:
          log(f"NAICS cache expired (cached {cache_time}, expires after {cache_days} days)")
      
    except Exception as e:
      log(f"Error reading NAICS cache: {e}")
    
    return None
  
  def cache_naics_choices(choices):
    """Cache NAICS choices locally"""
    cache_file = 'naics_choices_cache.json'
    
    try:
      cache_data = {
        'timestamp': datetime.now().isoformat(),
        'choices': choices,
        'count': len(choices)
      }
      
      with open(cache_file, 'w') as f:
        json.dump(cache_data, f)
      
      log(f"Cached {len(choices)} NAICS choices")
      
    except Exception as e:
      log(f"Error caching NAICS choices: {e}")
  
  def get_naics_choices_optimized():
    """Download the complete NAICS file (static dataset, not API)"""
    try:
      log("=== DOWNLOADING NAICS FILE (4MB) ===")
      
      headers = {
        'Accept': 'application/json',
        'User-Agent': 'Privacy-Compliance-Framework/1.0'
      }
      
      # Use reasonable timeout for 4MB file download
      response = requests.get(
        "https://api.sba.gov/naics/naics.json",
        headers=headers,
        timeout=30,
        stream=False
      )
      
      log(f"=== DOWNLOAD STATUS: {response.status_code}, SIZE: {len(response.content)} bytes ===")
      
      if response.status_code == 200:
        log("=== PARSING NAICS FILE ===")
        naics_data = response.json()
        
        log(f"=== FILE CONTAINS {len(naics_data)} NAICS RECORDS ===")
        
        # Process all records efficiently
        choices = []
        processed_count = 0
        
        for item in naics_data:
          naics_code = item.get('id', '').strip()
          naics_description = item.get('description', '').strip()
          
          if naics_code and naics_description and len(naics_code) == 6:
            # Truncate overly long descriptions
            if len(naics_description) > 120:
              naics_description = naics_description[:117] + "..."
            
            choices.append((naics_code, f"{naics_code}: {naics_description}"))
            processed_count += 1
          
          # Log progress every 500 records
          if processed_count % 500 == 0:
            log(f"Processed {processed_count} NAICS codes...")
        
        # Sort by description for better UX
        choices.sort(key=lambda x: x[1])
        
        log(f"=== SUCCESSFULLY PROCESSED {len(choices)} NAICS CODES FROM FILE ===")
        return choices
      
      else:
        log(f"=== DOWNLOAD FAILED: HTTP {response.status_code} ===")
        return None
        
    except requests.exceptions.Timeout:
      log("=== NAICS FILE DOWNLOAD TIMED OUT ===")
      return None
    except Exception as e:
      log(f"=== ERROR DOWNLOADING NAICS FILE: {e} ===")
      return None
  
  def filter_naics_choices(search_term):
    """Filter NAICS choices based on search term"""
    if not search_term or len(search_term) < 2:
      return naics_choices
    
    search_lower = search_term.lower()
    filtered = []
    
    for code, description in naics_choices:
      # Search in both code and description
      if (search_lower in code.lower() or 
          search_lower in description.lower()):
        filtered.append((code, description))
    
    # Limit results for performance
    return filtered[:100]
  
  def get_enhanced_fallback_naics_choices():
    """Enhanced fallback with more comprehensive industry coverage"""
    log("Using enhanced fallback NAICS choices")
    return [
      # Legal Services
      ("541110", "541110: Offices of Lawyers"),
      ("541191", "541191: Title Abstract and Settlement Offices"),
      ("541199", "541199: All Other Legal Services"),
      
      # Technology
      ("541511", "541511: Custom Computer Programming Services"),
      ("541512", "541512: Computer Systems Design Services"),
      ("541513", "541513: Computer Facilities Management Services"),
      ("541519", "541519: Other Computer Related Services"),
      ("518210", "518210: Data Processing, Hosting, and Related Services"),
      
      # Professional Services
      ("541211", "541211: Offices of Certified Public Accountants"),
      ("541213", "541213: Tax Preparation Services"),
      ("541214", "541214: Payroll Services"),
      ("541611", "541611: Administrative Management and General Management Consulting Services"),
      ("541612", "541612: Human Resources Consulting Services"),
      ("541613", "541613: Marketing Consulting Services"),
      ("541618", "541618: Other Management Consulting Services"),
      ("541990", "541990: All Other Professional, Scientific, and Technical Services"),
      
      # Healthcare
      ("621111", "621111: Offices of Physicians (except Mental Health Specialists)"),
      ("621112", "621112: Offices of Physicians, Mental Health Specialists"),
      ("621210", "621210: Offices of Dentists"),
      ("621310", "621310: Offices of Chiropractors"),
      ("621320", "621320: Offices of Optometrists"),
      ("621330", "621330: Offices of Mental Health Practitioners (except Physicians)"),
      ("621340", "621340: Offices of Physical, Occupational and Speech Therapists"),
      ("621420", "621420: Outpatient Mental Health and Substance Abuse Centers"),
      ("621511", "621511: Medical Laboratories"),
      ("621610", "621610: Home Health Care Services"),
      
      # Financial Services
      ("522110", "522110: Commercial Banking"),
      ("522120", "522120: Savings Institutions"),
      ("522130", "522130: Credit Unions"),
      ("522190", "522190: Other Depository Credit Intermediation"),
      ("522210", "522210: Credit Card Issuing"),
      ("522220", "522220: Sales Financing"),
      ("522291", "522291: Consumer Lending"),
      ("522292", "522292: Real Estate Credit"),
      ("522298", "522298: All Other Nondepository Credit Intermediation"),
      ("523110", "523110: Investment Banking and Securities Dealing"),
      ("523120", "523120: Securities Brokerage"),
      ("523210", "523210: Securities and Commodity Exchanges"),
      ("523920", "523920: Portfolio Management"),
      ("523930", "523930: Investment Advice"),
      ("524113", "524113: Direct Life Insurance Carriers"),
      ("524114", "524114: Direct Health and Medical Insurance Carriers"),
      ("524126", "524126: Direct Property and Casualty Insurance Carriers"),
      ("524210", "524210: Insurance Agencies and Brokerages"),
      
      # Retail
      ("441110", "441110: New Car Dealers"),
      ("442110", "442110: Furniture Stores"),
      ("443142", "443142: Electronics Stores"),
      ("444110", "444110: Home Centers"),
      ("445110", "445110: Supermarkets and Other Grocery (except Convenience) Stores"),
      ("446110", "446110: Pharmacies and Drug Stores"),
      ("448110", "448110: Men's Clothing Stores"),
      ("448120", "448120: Women's Clothing Stores"),
      ("451110", "451110: Sporting Goods Stores"),
      ("452112", "452112: Discount Department Stores"),
      
      # Manufacturing
      ("325412", "325412: Pharmaceutical Preparation Manufacturing"),
      ("334111", "334111: Electronic Computer Manufacturing"),
      ("336111", "336111: Automobile Manufacturing"),
      
      # Construction
      ("236115", "236115: New Single-Family Housing Construction (except For-Sale Builders)"),
      ("236220", "236220: Commercial and Institutional Building Construction"),
      ("238110", "238110: Poured Concrete Foundation and Structure Contractors"),
      ("238210", "238210: Electrical Contractors and Other Wiring Installation Contractors"),
      ("238220", "238220: Plumbing, Heating, and Air-Conditioning Contractors"),
      
      # Real Estate
      ("531110", "531110: Lessors of Residential Buildings and Dwellings"),
      ("531210", "531210: Offices of Real Estate Agents and Brokers"),
      ("531311", "531311: Residential Property Managers"),
      
      # Education
      ("611110", "611110: Elementary and Secondary Schools"),
      ("611310", "611310: Colleges, Universities, and Professional Schools"),
      ("611420", "611420: Computer Training"),
      ("611691", "611691: Exam Preparation and Tutoring"),
      
      # Food Service
      ("722511", "722511: Full-Service Restaurants"),
      ("722513", "722513: Limited-Service Restaurants"),
      
      # Other
      ("999999", "999999: Other - Please specify in additional information")
    ]
  
  def get_industry_from_naics(naics_code):
    """Derive broad industry category from NAICS code"""
    if not naics_code or len(str(naics_code)) < 2:
      return "Other"
    
    # Convert to string and extract just the code if it's in "code: description" format
    naics_str = str(naics_code)
    if ':' in naics_str:
      naics_str = naics_str.split(':')[0].strip()
    
    # Map NAICS sectors to broad industry categories
    if len(naics_str) >= 2:
      sector = naics_str[:2]
      
      naics_to_industry = {
        "62": "Healthcare",
        "52": "Financial Services",
        "51": "Technology",
        "54": "Professional Services",
        "44": "Retail",
        "45": "Retail",
        "61": "Education",
        "31": "Manufacturing",
        "32": "Manufacturing",
        "33": "Manufacturing",
        "23": "Construction",
        "53": "Real Estate",
        "72": "Food Service",
      }
      
      return naics_to_industry.get(sector, "Other")
    
    return "Other"
  
  def load_naics_data_async():
    """Load NAICS data in background with comprehensive error handling"""
    global naics_loading_status, naics_choices, naics_load_error
    
    naics_loading_status = "loading"
    naics_load_error = None
    
    try:
      log("Starting NAICS data load...")
      
      # Try to get from cache first (cache for 7 days since it's a static file)
      cached_choices = get_cached_naics_choices(cache_days=7)
      if cached_choices:
        naics_choices = cached_choices
        naics_loading_status = "complete"
        log(f"Loaded {len(naics_choices)} NAICS codes from cache")
        return
      
      # Only download the large file if cache is empty/expired
      log("Cache miss - attempting to download NAICS file...")
      api_choices = get_naics_choices_optimized()
      
      if api_choices and len(api_choices) > 100:
        naics_choices = api_choices
        cache_naics_choices(api_choices)
        naics_loading_status = "complete"
        log(f"Downloaded and cached {len(naics_choices)} NAICS codes")
      else:
        # Fallback to static choices
        naics_choices = get_enhanced_fallback_naics_choices()
        naics_loading_status = "fallback"
        log(f"Using fallback NAICS choices ({len(naics_choices)} codes)")
        
    except Exception as e:
      log(f"Error loading NAICS data: {e}")
      naics_choices = get_enhanced_fallback_naics_choices()
      naics_loading_status = "error"
      naics_load_error = str(e)
---
# Initialize variables - This prevents undefined variable errors
code: |
  # Initialize loading status if not already set
  if not defined('naics_loading_status'):
    naics_loading_status = "not_started"
  
  # Ensure naics_choices is always defined
  if not defined('naics_choices'):
    naics_choices = get_enhanced_fallback_naics_choices()
  
  # Trigger background loading when basic info is complete
  if defined('basic_business_info_complete') and basic_business_info_complete and not defined('naics_loading_triggered'):
    log("=== TRIGGERING NAICS DATA LOAD ===")
    load_naics_data_async()
    naics_loading_triggered = True
    log(f"=== NAICS LOAD COMPLETE. Status: {naics_loading_status}, Choices count: {len(naics_choices)} ===")
---
# Business information introduction
question: "Step 1: Business Information"
subquestion: |
  Let's start by gathering some basic information about your business.
  
  This information will help us:
  - Determine which privacy laws apply to your organization
  - Assess your compliance requirements
  - Generate appropriate documentation
  
  The process will take approximately 10-15 minutes.

continue button field: business_profile_complete
continue button label: "Let's get started"
---
# Step 1: Basic business information (no API dependency)
question: "Step 1a: Basic Business Information"
subquestion: |
  Let's start with your basic business information while we prepare the industry classification options.
fields:
  - Company Name: company.name
    required: True
  - Number of Employees: company.employee_count
    datatype: integer
    required: True
  - Annual Revenue (USD): company.annual_revenue
    datatype: currency
    required: True
continue button field: basic_business_info_complete
---
# Loading screen with progress indication
question: "Preparing Industry Classifications..."
subquestion: |
  % if naics_loading_status == "loading":
  <div class="text-center">
    <div class="spinner-border" role="status">
      <span class="sr-only">Loading...</span>
    </div>
    <p class="mt-3">Loading industry classification data from the Small Business Administration...</p>
    <p class="text-muted">This may take a moment for the most current information.</p>
  </div>
  % elif naics_loading_status == "complete":
  ✅ Industry classifications loaded successfully!
  % elif naics_loading_status == "fallback":
  ⚠️ Using standard industry classifications (SBA data temporarily unavailable)
  % elif naics_loading_status == "error":
  ❌ Error loading current data. Using standard classifications.
  % endif

# Auto-refresh every 2 seconds while loading
script: |
  <script>
    if ("${naics_loading_status}" === "loading") {
      setTimeout(function() {
        $("#nav-submit").click();
      }, 2000);
    }
  </script>

continue button field: naics_loading_screen
continue button label: |
  % if naics_loading_status == "loading":
  Please wait...
  % else:
  Continue
  % endif
---
# Enhanced NAICS selection with search capabilities
question: "Step 1b: Industry Classification" 
subquestion: |
  % if naics_loading_status == "complete":
  Select your primary business activity from the current SBA NAICS codes:
  % elif naics_loading_status == "fallback":
  Select your primary business activity from our standard classifications:
  % else:
  Select your primary business activity:
  % endif
  
  **Tip**: You can type to search for your industry (e.g., "legal services", "software", "retail")

fields:
  - Search for your industry: naics_search_term
    required: False
    help: |
      Start typing to filter the list below. You can search by industry name or NAICS code.
  - Primary Business Activity (NAICS Code): company.naics_code
    required: True
    datatype: combobox
    choices: 
      code: |
        filter_naics_choices(naics_search_term) if defined('naics_search_term') and naics_search_term else naics_choices
    help: |
      % if naics_loading_status == "complete":
      Current SBA NAICS codes with size standards
      % else:
      Standard industry classifications
      % endif

continue button field: naics_selection_complete
---
# Set industry and format display values AFTER NAICS selection
code: |
  # Set industry based on NAICS selection
  if defined('naics_selection_complete') and naics_selection_complete and defined('company.naics_code') and company.naics_code:
    company.industry = get_industry_from_naics(company.naics_code)
    
    # Format the display values
    naics_str = str(company.naics_code).strip()
    if ':' in naics_str:
      company_naics_display = naics_str.split(':')[0].strip()
    else:
      company_naics_display = naics_str
  else:
    company.industry = "Other"
    company_naics_display = "Not selected"
  
  # Format other display values
  if defined('company.employee_count') and company.employee_count:
    company_employee_display = "{:,}".format(int(company.employee_count))
  else:
    company_employee_display = "Not specified"
  
  if defined('company.annual_revenue') and company.annual_revenue:
    company_revenue_display = "${:,.0f}".format(float(company.annual_revenue))
  else:
    company_revenue_display = "Not specified"
---
# Industry confirmation and additional fields
question: Business Profile Complete
subquestion: |
  **Company**: ${ company.name }  
  **NAICS Code**: ${ company_naics_display }  
  **Industry**: ${ company.industry }  
  **Employees**: ${ company_employee_display }  
  **Annual Revenue**: ${ company_revenue_display }

  % if defined('naics_loading_status') and (naics_loading_status == "fallback" or naics_loading_status == "error"):
  **Note**: Industry classification was selected from standard options. Current SBA data was not available during this session.
  % endif

fields:
  - "Is this information correct?": business_profile_confirmed
    datatype: yesnoradio
  - "Additional business description (optional)": company.description
    datatype: area
    required: False
    help: |
      Any additional information about your business activities that might affect privacy compliance requirements.

continue button field: show_business_information_intro
---
# Geographic and operational scope questions
question: Geographic and Operational Scope
subquestion: |
  Now let's determine your geographic and operational scope to identify applicable privacy laws.

fields:
  - "Does your business have a website?": business_has_website
    datatype: yesnowide
  - "Does your business have physical locations where customers visit?": business_has_physical_location
    datatype: yesnowide
  - "In which states/provinces do you have business locations?": states_with_locations
    datatype: checkboxes
    choices:
      - Alabama
      - Alaska
      - Arizona
      - Arkansas
      - California
      - Colorado
      - Connecticut
      - Delaware
      - Florida
      - Georgia
      - Hawaii
      - Idaho
      - Illinois
      - Indiana
      - Iowa
      - Kansas
      - Kentucky
      - Louisiana
      - Maine
      - Maryland
      - Massachusetts
      - Michigan
      - Minnesota
      - Mississippi
      - Missouri
      - Montana
      - Nebraska
      - Nevada
      - New Hampshire
      - New Jersey
      - New Mexico
      - New York
      - North Carolina
      - North Dakota
      - Ohio
      - Oklahoma
      - Oregon
      - Pennsylvania
      - Rhode Island
      - South Carolina
      - South Dakota
      - Tennessee
      - Texas
      - Utah
      - Vermont
      - Virginia
      - Washington
      - West Virginia
      - Wisconsin
      - Wyoming
    none of the above: False
  - "Do you serve customers or clients in the European Union?": serves_eu
    datatype: yesnowide
  - "Do you have an establishment (office, subsidiary, etc.) in the EU?": has_eu_establishment
    datatype: yesnowide
  - "Approximately how many California residents' personal information do you process annually?": california_records
    datatype: integer
    help: Include customers, employees, vendors, etc.
  - "Approximately how many Texas residents' personal information do you process annually?": texas_records
    datatype: integer
    help: Include customers, employees, vendors, etc.
  - "Do you sell personal information to third parties?": sells_personal_info
    datatype: yesnowide
    help: This includes sharing for advertising, marketing lists, or other commercial purposes
continue button field: geographic_scope_complete
---
# Healthcare-specific questions (conditional)
question: Healthcare Industry Questions
subquestion: |
  Since you're in the healthcare industry, we need to assess HIPAA applicability.
fields:
  - "Are you a HIPAA covered entity (healthcare provider, health plan, or healthcare clearinghouse)?": is_hipaa_covered_entity
    datatype: yesnowide
    help: Covered entities are directly regulated by HIPAA
  - "Are you a business associate of a HIPAA covered entity?": is_hipaa_business_associate
    datatype: yesnowide
    help: Business associates provide services to covered entities and handle PHI
  - "Do you process protected health information (PHI)?": processes_phi
    datatype: yesnowide
    help: PHI includes individually identifiable health information
continue button field: healthcare_questions_complete
---
# Financial services questions (conditional)
question: Financial Services Industry Questions
subquestion: |
  Since you're in the financial services industry, we need to assess GLBA applicability.
fields:
  - "Are you a financial institution as defined by GLBA?": is_glba_financial_institution
    datatype: yesnowide
    help: Banks, credit unions, securities firms, insurance companies, etc.
  - "Do you provide financial products or services to consumers?": provides_financial_products
    datatype: yesnowide
    help: Loans, investments, insurance, financial advice, etc.
  - "Do you collect nonpublic personal information from customers?": collects_npi
    datatype: yesnowide
    help: Information not publicly available, such as account numbers, income, credit history
continue button field: financial_questions_complete
---
# Conditional logic for industry-specific questions
code: |
  # Healthcare questions only if healthcare industry
  if company.industry == "Healthcare":
    healthcare_questions_complete
  else:
    healthcare_questions_complete = True
    # Set default values for healthcare variables
    is_hipaa_covered_entity = False
    is_hipaa_business_associate = False
    processes_phi = False
  
  # Financial services questions only if financial industry
  if company.industry == "Financial Services":
    financial_questions_complete
  else:
    financial_questions_complete = True
    # Set default values for financial variables
    is_glba_financial_institution = False
    provides_financial_products = False
    collects_npi = False
---